# 專案計畫：訓練高保真「圖像重建」LoRA 模型

---

### **1. 專案目標**

訓練一個高度特化的 LoRA 模型，使其能將特定主題的、經過複雜退化（模糊、噪點、壓縮）的圖像，精準地重建為具有真實感細節與自然紋理的高解析度版本。

### **2. 核心策略**

採用「直接對應關係」的訓練方法，基於一個強大的寫實風格 `Stable Diffusion 1.5` 模型，提供成對的「退化圖像」(作為輸入/正規化)與「高清圖像」(作為目標/訓練集)，讓 LoRA 學習一個從「低品質」到「高品質」的直接視覺轉換規則。

---


### **階段一：設定與資料準備 (基礎建設)**

1.  **建立資料夾結構**：在 `D:\python_project\photo_enhancer\` 內，建立以下子資料夾：
    *   `dataset/train/1_/`
    *   `dataset/reg/1_/`
    *   `model/`
    *   `output/`
    *   `log/`

2.  **放置基礎模型**：下載一個推薦的寫實風格基礎模型（如 `Realistic Vision`），將其 `.safetensors` 檔案放入 `model/` 資料夾。

3.  **準備高清目標圖 (Target)**：將所有高清原圖放入 `dataset/train/10_targets/` 資料夾。

4.  **製作退化輸入圖 (Input)**：
    *   使用您提供的 `lr_image.py` 腳本。
    *   以 `train` 資料夾中的高清圖為來源，生成對應的、經過複雜隨機退化處理的圖像。
    *   將這些生成的退化圖像，以**與高清圖完全相同的檔名**，儲存到 `dataset/reg/1_/` 資料夾中。


---


### **階段二：基準模型訓練 (Baseline Training)**

1.  啟動 Kohya's SS GUI。
2.  **路徑設定 (`Folders` 頁籤)**：精確設定圖片、正規化、輸出及日誌資料夾的路徑。
3.  **模型設定 (`Source Model` 頁籤)**：選擇您在階段一放入的基礎模型。
4.  **訓練參數設定 (`Training parameters` 頁籤)**：採用以下經過精煉的初始參數：
    *   **Epoch**: `20`
    *   **Save every N epochs**: `5`
    *   **Learning Rate**: `5e-6` (0.000005)
    *   **Text Encoder learning rate**: `1e-6` (0.000001)
    *   **Network Rank (Dimension)**: `128`
    *   **Network Alpha**: `64`
    *   **Optimizer**: `AdamW8bit`
    *   **Train batch size**: `1`
    *   **LR Scheduler**: `cosine_with_restarts`
5.  **開始訓練**：使用「儲存並重新載入設定檔」的技巧確保參數無誤後，點擊 `Start training`。

---


### **階段三：評估與分析 (Evaluation)**

1.  **生成測試圖集**：在 `AUTOMATIC1111` 等 WebUI 的 `img2img` 功能中，對**每一輪**儲存的 LoRA 模型 (`-000005`, `-000010`...)，在一系列不同的**重繪強度** (`0.5`, `0.6`, `0.7`...) 下，處理固定的測試用退化圖。
2.  **量化分析**：建立一個 `evaluate_quality.py` 腳本，計算每一張生成圖相對於其高清原圖的 `PSNR`, `SSIM`, `LPIPS` 分數。
3.  **記錄與比較**：建立一個簡單的表格（如 Excel），記錄所有組合下的指標分數，找出客觀上的最優模型與參數。
4.  **質化分析**：用肉眼觀察，結合數據，找出視覺效果最自然、修復效果最好的結果。

---


### **階段四：迭代與優化 (Tuning Loop)**

1.  **分析結果**：根據階段三的數據與觀察，確定當前最佳模型版本的潛在問題（如：細節不足、仍有殘留瑕疵等）。
2.  **制定新策略**：基於問題，提出下一個實驗的改進方案（例如：微調學習率、擴充資料集的多樣性、更換基礎模型等）。
3.  **重複循環**：帶著新的設定回到**階段二**，從**乾淨的原始基礎模型**出發，訓練一個新的 LoRA 版本，並再次進行階段三的評估。這個循環是通往完美模型的必經之路。

---


### **階段五：最終應用**

當您在調優循環中，對某個 LoRA 版本的修復效果完全滿意時，該 LoRA 及其對應的最佳推論參數（如重繪強度），即成為您這個專案的最終交付成果，可整合進您未來的圖像處理工作流中。
